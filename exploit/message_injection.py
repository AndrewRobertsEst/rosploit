from core import Message
from core import Node
from core import StateException
from core import Topic


def message_injection(target_node: Node, target_topic: Topic, node_name: str, message: Message):
    """
    Inject data into a topic
    :param target_node: The node you want to inject data into. It could be a list
    :param target_topic: The Topic you want ot inject data into
    :param node_name: The name to give for this script.
    :param message: The message to inject.
    :return:
    """
    # TODO: Create a connection here
    injection_url = "http://localhost:12345"
    # TODO: If there is no node we should instead publish to all
    (_, _, target_bus) = target_node.get_sub_list(node_name=node_name)
    subscriber_list = []
    for s in target_node.sub_topics:
        if target_topic.name in s:
            subscriber_list.append(s)
    if len(subscriber_list) is 0:
        raise StateException("Node is not subscribed to topic ")
    else:
        # TODO: THIS SHOULDN'T DO ANYTHING
        for subscriber in subscriber_list:
            # TODO: CONSIDER KEEPING THE OTHERS
            target_node.server.publisherUpdate(node_name, subscriber.name, [injection_url])
            target_topic.publish(message=message)
